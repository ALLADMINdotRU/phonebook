{% extends "base.html" %}

{% block styles %}
<style>
.contacts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
}

/* Скрываем элементы полностью */
.d-none {
    display: none !important;
}

/* Анимация для фотографии контакта при наведении */
.contact-photo {
    transition: all 0.3s ease;
    transform: scale(1);
}

.contact-avatar {
    transition: all 0.3s ease;
    transform: scale(1);
}

.contact-card:hover .contact-photo,
.contact-card:hover .contact-avatar {
    transform: scale(1.5);
    z-index: 1000;
    position: relative;
    box-shadow: 0 15px 40px rgba(0,0,0,0.3);
}

/* Плавная анимация всей карточки */
.contact-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.contact-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

/* Плавный скроллинг для всей страницы */
html {
    scroll-behavior: smooth;
}

/* Отступ при скролле к карточке */
.contact-card {
    scroll-margin-top: 20px;
}

/* Плавающая кнопка "Наверх" */
.scroll-to-top-btn {
    /* Фиксированное позиционирование для плавающего эффекта */
    position: fixed;
    /* Позиционирование по центру справа экрана */
    top: 50%;
    right: 20px;
    /* Точное центрирование по вертикали */
    transform: translateY(-50%);
    /* Размеры круглой кнопки */
    width: 50px;
    height: 50px;
    /* Круглая форма */
    border-radius: 50%;
    /* Цвет фона и текста */
    background-color: #007bff;
    color: white;
    /* Убираем стандартную рамку */
    border: none;
    /* Курсор при наведении */
    cursor: pointer;
    /* Высокий z-index чтобы кнопка была поверх других элементов */
    z-index: 1000;
    /* Центрирование содержимого */
    display: flex;
    align-items: center;
    justify-content: center;
    /* Размер иконки */
    font-size: 20px;
    /* Изначально скрыта */
    opacity: 0;
    visibility: hidden;
    /* Плавные переходы для анимации */
    transition: all 0.3s ease;
}

/* Класс для показа кнопки */
.scroll-to-top-btn.show {
    /* Показываем кнопку */
    opacity: 1;
    visibility: visible;
}

/* Эффекты при наведении на кнопку */
.scroll-to-top-btn:hover {
    /* Темнее цвет фона при наведении */
    background-color: #0056b3;
    /* Увеличиваем кнопку и сохраняем центрирование */
    transform: translateY(-50%) scale(1.1);
}

/* Стили для темной темы */
[data-bs-theme="dark"] .scroll-to-top-btn {
    /* Серый цвет для темной темы */
    background-color: #6c757d;
}

/* Эффекты при наведении в темной теме */
[data-bs-theme="dark"] .scroll-to-top-btn:hover {
    /* Темнее серый при наведении */
    background-color: #545b62;
}

/* Стили для алфавитного указателя */
.alphabet-index {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    padding: 10px 0;
    border-top: 1px solid #dee2e6;
    margin-top: 15px;
}

/* Стили для букв алфавита */
.alphabet-letter {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 35px;
    height: 35px;
    background-color: #f8f9fa;
    color: #495057;
    text-decoration: none;
    border-radius: 4px;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s ease;
    border: 1px solid #dee2e6;
}

/* Эффекты при наведении на букву */
.alphabet-letter:hover {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
}

/* Стили для активной буквы */
.alphabet-letter.active {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
}

/* Стили для темной темы */
[data-bs-theme="dark"] .alphabet-index {
    border-top-color: #495057;
}

[data-bs-theme="dark"] .alphabet-letter {
    background-color: #343a40;
    color: #e9ecef;
    border-color: #495057;
}

[data-bs-theme="dark"] .alphabet-letter:hover {
    background-color: #6c757d;
    color: white;
    border-color: #6c757d;
}

[data-bs-theme="dark"] .alphabet-letter.active {
    background-color: #6c757d;
    color: white;
    border-color: #6c757d;
}

/* Стили для выпадающего навбара только на странице телефонной книги */
.navbar-collapsible {
    position: fixed;
    top: -60px;
    left: 0;
    right: 0;
    z-index: 1030;
    transition: top 0.3s ease;
}

.navbar-collapsible.show {
    top: 0;
}

.navbar-activation-area {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 30px;
    z-index: 1029;
    background: transparent;
}

/* Непрозрачный фон для навбара чтобы не сливался с контентом */
.navbar-collapsible {
    background-color: #f8f9fa;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

/* Для темной темы */
[data-bs-theme="dark"] .navbar-collapsible {
    background-color: #343a40;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

/* Компенсация для контента при скрытом навбаре */
body {
    padding-top: 0;
}

</style>
{% endblock %}


{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
                        
            <!-- Поиск и фильтры -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <input type="text" id="searchInput" class="form-control" 
                                   placeholder="Поиск по имени, email, телефону, должности, отделу, организации...">
                        </div>
                        <div class="col-md-4">
                            <select id="organizationFilter" class="form-select">
                                <option value="">Все организации</option>
                                {% for org in organizations %}
                                <option value="{{ org }}">{{ org }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="button" onclick="clearFilters()" class="btn btn-outline-secondary w-100">
                                Очистить
                            </button>
                        </div>
                    </div>
                    
                    <!-- Алфавитный указатель -->
                    <div class="mt-3">
                        <div class="alphabet-index">
                            {% set letters = [] %}
                            {% for contact in contacts %}
                                {% if contact.cn and contact.cn[0] %}
                                    {% set first_letter = contact.cn[0].upper() %}
                                    {% if first_letter not in letters %}
                                        {% set _ = letters.append(first_letter) %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            {% set letters = letters|sort %}
                            
                            {% for letter in letters %}
                                <a href="#letter-{{ letter }}" class="alphabet-letter" data-letter="{{ letter }}">
                                    {{ letter }}
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Результаты -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0" id="resultsCounter">Всего контактов: {{ total_contacts }}</h5>
                </div>
                <div class="card-body">
                    <div id="noResults" class="text-center py-5" style="display: none;">
                        <i class="bi bi-search display-1 text-muted"></i>
                        <h4 class="mt-3">Контакты не найдены</h4>
                        <p class="text-muted">Попробуйте изменить параметры поиска</p>
                    </div>
                    
                    <div id="contacts-cards-container" class="row">
                        {% for contact in contacts %}
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card h-100 contact-card" 
                                data-name="{{ contact.cn }}"
                                data-email="{{ contact.mail or '' }}"
                                data-phone="{{ contact.telephone or '' }}"
                                data-mobile="{{ contact.mobile or '' }}"
                                data-title="{{ contact.title or '' }}"
                                data-department="{{ contact.department or '' }}"
                                data-organization="{{ contact.organization }}">
                                
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        {% if contact.photo %}
                                        <img src="data:image/jpeg;base64,{{ contact.photo }}" 
                                            alt="{{ contact.cn }}" 
                                            class="rounded-circle me-3 contact-photo" 
                                            style="width: 60px; height: 60px; object-fit: cover;">
                                        {% else %}
                                        <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center me-3 contact-avatar" 
                                            style="width: 60px; height: 60px;">
                                            <span class="text-white fs-4">{{ contact.cn[0] if contact.cn else '?' }}</span>
                                        </div>
                                        {% endif %}
                                        <div>
                                            <h5 class="card-title mb-0">{{ contact.cn }}</h5>
                                            {% if contact.title %}
                                            <p class="text-muted mb-0">{{ contact.title }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="contact-info">
                                        {% if contact.mail %}
                                        <div class="mb-2">
                                            <i class="bi bi-envelope me-2"></i>
                                            <a href="mailto:{{ contact.mail }}" class="text-decoration-none">
                                                {{ contact.mail }}
                                            </a>
                                        </div>
                                        {% endif %}
                                        
                                        {% if contact.telephone %}
                                        <div class="mb-2">
                                            <i class="bi bi-telephone me-2"></i>
                                            <a href="tel:{{ contact.telephone }}" class="text-decoration-none">
                                                {{ contact.telephone }}
                                            </a>
                                        </div>
                                        {% endif %}
                                        
                                        {% if contact.mobile %}
                                        <div class="mb-2">
                                            <i class="bi bi-phone me-2"></i>
                                            <a href="tel:{{ contact.mobile }}" class="text-decoration-none">
                                                {{ contact.mobile }}
                                            </a>
                                        </div>
                                        {% endif %}
                                        
                                        {% if contact.organization %}
                                        <div class="mb-2">
                                            <i class="bi bi-building me-2"></i>
                                            <span class="text-muted">{{ contact.organization }}</span>
                                        </div>
                                        {% endif %}
                                        
                                        {% if contact.department %}
                                        <div class="mb-2">
                                            <i class="bi bi-diagram-3 me-2"></i>
                                            <span class="text-muted">{{ contact.department }}</span>
                                        </div>
                                        {% endif %}
                                        <!-- геопоизция -->
                                        <div class="mb-2">
                                        {% if contact.is_on_map %}
                                            <a href="{{ url_for('phonebook.view_map', server_id=contact.server_id, user_id=contact.id) }}" 
                                                class="btn btn-outline-primary btn-sm" 
                                                target="_blank"
                                                title="Показать расположение на карте">
                                                <i class="bi bi-geo-alt-fill"></i>
                                            </a>                                        
                                        {% endif %}
                                        <!-- Иконка почты -->
                                        {% if contact.mail %}
                                            <a href="mailto:{{ contact.mail }}" 
                                                class="btn btn-outline-secondary btn-sm ms-1"
                                                title="Написать письмо">
                                                <i class="bi bi-envelope"></i>
                                            </a>
                                        {% endif %}
                                        <!-- WhatsApp иконка -->
                                        {% if contact.mobile %}
                                        {% set clean_mobile = contact.mobile | replace(' ', '') | replace('-', '') | replace('(', '') | replace(')', '') %}
                                            <a href="https://wa.me/{{ clean_mobile }}" 
                                                class="btn btn-outline-success btn-sm ms-1"
                                                target="_blank"
                                                title="Написать в WhatsApp">
                                                <i class="bi bi-whatsapp"></i>
                                            </a>
                                        {% endif %}
                                        <!-- Telegram иконка -->
                                        {% if contact.mobile %}
                                        {% set clean_mobile = contact.mobile | replace(' ', '') | replace('-', '') | replace('(', '') | replace(')', '') %}
                                            <a href="https://t.me/{{ clean_mobile }}" 
                                                class="btn btn-outline-info btn-sm ms-1"
                                                target="_blank"
                                                title="Написать в Telegram">
                                                <i class="bi bi-telegram"></i>
                                            </a>
                                        {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Плавающая кнопка "Наверх" -->
<button id="scrollToTopBtn" class="scroll-to-top-btn" title="Наверх">
    <i class="bi bi-arrow-up"></i>
</button>

{% endblock %}

{% block scripts %}

<script src="{{ url_for('phonebook.static', filename='phonebook/script.js') }}"></script>

<!-- Плавный скролинг -->
<script src="{{ url_for('phonebook.static', filename='phonebook/smoothscroll.js') }}"></script>
<script src="js/smoothscroll.min.js"></script>
<script>
    SmoothScroll({ 
        // Длительность анимации скроллинга в миллисекундах
        animationTime: 850,           // ← Чем больше значение, тем плавнее и медленнее скроллинг
        
        // Количество пикселей для скролла за один шаг (при использовании колеса мыши)
        stepSize: 120,                // ← Стандартное значение, соответствует одному "щелчку" колеса
        
        // Включение поддержки тачпадов (ноутбуки)
        touchpadSupport: true,        // ← Если false, на тачпадах будет обычный скроллинг
        
        // Изменение скорости скролла при быстром прокручивании колеса
        accelerationDelta: 20,        // ← Порог скорости для активации ускорения (в пикселях)
        accelerationMax: 2,           // ← Максимальный коэффициент ускорения (2 = в 2 раза быстрее)
        
        // Алгоритм плавности скролла
        pulseAlgorithm: true,         // ← Включение "пульсирующего" алгоритма для более естественного скролла
        pulseScale: 4,                // ← Масштаб импульса (влияет на кривую замедления)
        pulseNormalize: 1,            // ← Нормализация импульса (регулирует интенсивность)
        
        // Поддержка клавиатуры (стрелки, PageUp/Down, пробел)
        keyboardSupport: true,        // ← Если false, клавиши скроллинга будут работать стандартно
        
        // Скорость скролла при нажатии клавиш-стрелок (в пикселях в секунду)
        arrowScroll: 75               // ← Определяет как быстро происходит скролл стрелками
    })
</script>

<script>
// Функция для плавающей кнопки "Наверх"
document.addEventListener('DOMContentLoaded', function() {
    // Находим кнопку по ID
    const scrollToTopBtn = document.getElementById('scrollToTopBtn');
    
    // Проверяем что кнопка существует
    if (!scrollToTopBtn) {
        console.error('Кнопка "Наверх" не найдена!');
        return;
    }
    
    // Обработчик скролла страницы
    window.addEventListener('scroll', function() {
        // Проверяем позицию прокрутки
        // Если прокрутили больше 300px от верха страницы
        if (window.pageYOffset > 300) {
            // Добавляем класс для показа кнопки
            scrollToTopBtn.classList.add('show');
        } else {
            // Убираем класс для скрытия кнопки
            scrollToTopBtn.classList.remove('show');
        }
    });
    
    // Обработчик клика по кнопке
    scrollToTopBtn.addEventListener('click', function() {
        // Плавная прокрутка страницы в начало
        window.scrollTo({
            top: 0,                    // Прокрутка к верху страницы
            behavior: 'smooth'         // Плавная анимация прокрутки
        });
    });
});

// Функция для алфавитного указателя
document.addEventListener('DOMContentLoaded', function() {
    // Находим все буквы алфавита
    const alphabetLetters = document.querySelectorAll('.alphabet-letter');
    
    // Добавляем обработчики клика для каждой буквы
    alphabetLetters.forEach(function(letter) {
        letter.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Получаем букву из data-атрибута
            const targetLetter = this.getAttribute('data-letter');
            
            // Находим первую карточку контакта с этой буквой
            const contactCards = document.querySelectorAll('.contact-card');
            let targetCard = null;
            
            // Ищем первую карточку с фамилией, начинающейся на нужную букву
            for (let card of contactCards) {
                const contactName = card.getAttribute('data-name');
                if (contactName && contactName.toUpperCase().startsWith(targetLetter)) {
                    targetCard = card;
                    break;
                }
            }
            
            // Если нашли карточку, прокручиваем к ней
            if (targetCard) {
                // Добавляем отступ для компенсации фиксированного навбара
                const navbarHeight = document.querySelector('.navbar').offsetHeight;
                const cardPosition = targetCard.getBoundingClientRect().top + window.pageYOffset;
                
                // Плавная прокрутка к карточке с учетом высоты навбара
                window.scrollTo({
                    top: cardPosition - navbarHeight - 20,
                    behavior: 'smooth'
                });
                
                // Добавляем подсветку активной буквы
                alphabetLetters.forEach(function(l) {
                    l.classList.remove('active');
                });
                this.classList.add('active');
                
                // Убираем подсветку через 2 секунды
                setTimeout(function() {
                    letter.classList.remove('active');
                }, 2000);
            }
        });
    });
});

// Функция для выпадающего навбара
function initCollapsibleNavbar() {
    const navbar = document.querySelector('.navbar');
    if (!navbar) return;
    
    // Добавляем классы для анимации
    navbar.classList.add('navbar-collapsible');
    
    // Создаем область активации
    const activationArea = document.createElement('div');
    activationArea.className = 'navbar-activation-area';
    document.body.appendChild(activationArea);
    
    let navbarTimeout;
    
    // Обработчики событий
    activationArea.addEventListener('mouseenter', () => {
        clearTimeout(navbarTimeout);
        navbar.classList.add('show');
    });
    
    activationArea.addEventListener('mouseleave', () => {
        navbarTimeout = setTimeout(() => {
            navbar.classList.remove('show');
        }, 2000);
    });
    
    navbar.addEventListener('mouseenter', () => {
        clearTimeout(navbarTimeout);
    });
    
    navbar.addEventListener('mouseleave', () => {
        navbarTimeout = setTimeout(() => {
            navbar.classList.remove('show');
        }, 1000);
    });
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', initCollapsibleNavbar);
</script>

{% endblock %}
